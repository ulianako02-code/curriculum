<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моё Расписание МГУ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Моё Расписание</h1>

        <!-- Календарь-неделя -->
        <div class="card mb-4">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <button class="btn btn-sm btn-outline-primary" id="prevWeek">←</button>
                    <h5 class="mb-0" id="currentWeekRange">Загрузка...</h5>
                    <button class="btn btn-sm btn-outline-primary" id="nextWeek">→</button>
                </div>
                <div class="d-flex justify-content-between" id="weekDays">
                    <!-- Дни недели будут вставлены здесь через JavaScript -->
                </div>
            </div>
        </div>

        <!-- Контейнер для расписания -->
        <div id="scheduleContainer">
            <div class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2">Загружаем расписание...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentWeekStart = null;
            const today = new Date();
            let selectedDate = new Date(today); // По умолчанию выбран сегодняшний день

            // Элементы DOM
            const weekDaysContainer = document.getElementById('weekDays');
            const weekRangeElement = document.getElementById('currentWeekRange');
            const scheduleContainer = document.getElementById('scheduleContainer');
            const prevWeekButton = document.getElementById('prevWeek');
            const nextWeekButton = document.getElementById('nextWeek');

            // Названия дней недели
            const daysOfWeek = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

            // Инициализация календаря
            function initCalendar() {
                // Находим понедельник текущей недели
                currentWeekStart = new Date(today);
                const dayOfWeek = today.getDay(); // 0 (воскресенье) - 6 (суббота)
                // Корректируем, чтобы понедельник был первым днем недели
                const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
                currentWeekStart.setDate(today.getDate() + diffToMonday);

                renderWeekCalendar(currentWeekStart);
                loadScheduleForDate(formatDate(selectedDate)); // Загружаем расписание на выбранную дату
            }

            // Отрисовка календаря на неделю
            function renderWeekCalendar(startDate) {
                weekDaysContainer.innerHTML = '';
                const weekStart = new Date(startDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);

                // Обновляем заголовок с диапазоном недели
                weekRangeElement.textContent = `${formatDate(weekStart, 'dd.MM')} - ${formatDate(weekEnd, 'dd.MM.yyyy')}`;

                // Создаем элементы для каждого дня недели
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(weekStart);
                    dayDate.setDate(weekStart.getDate() + i);

                    const dayElement = document.createElement('div');
                    dayElement.className = 'day text-center p-1 flex-fill';
                    dayElement.setAttribute('data-date', formatDate(dayDate));

                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'fw-bold';
                    dayNumber.textContent = dayDate.getDate();

                    const dayName = document.createElement('div');
                    dayName.className = 'small text-muted';
                    dayName.textContent = daysOfWeek[i];

                    // Подсвечиваем сегодняшний день
                    if (isSameDay(dayDate, today)) {
                        dayNumber.classList.add('text-white', 'bg-primary', 'rounded-circle', 'mx-auto');
                        dayNumber.style.width = '2rem';
                        dayNumber.style.height = '2rem';
                        dayNumber.style.lineHeight = '2rem';
                    }

                    // Подсвечиваем выбранный день
                    if (isSameDay(dayDate, selectedDate)) {
                        dayElement.classList.add('selected-day');
                    }

                    dayElement.appendChild(dayNumber);
                    dayElement.appendChild(dayName);
                    dayElement.addEventListener('click', () => selectDay(dayDate));
                    weekDaysContainer.appendChild(dayElement);
                }
            }

            // Выбор дня в календаре
            function selectDay(date) {
                selectedDate = date;
                loadScheduleForDate(formatDate(date));
                renderWeekCalendar(currentWeekStart); // Перерисовываем календарь, чтобы обновить выделение
            }

            // Загрузка расписания с сервера
            function loadScheduleForDate(dateStr) {
                scheduleContainer.innerHTML = `
                    <div class="text-center my-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загружаем расписание...</p>
                    </div>
                `;

                fetch(`/api/schedule?date=${dateStr}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Ошибка сети');
                        }
                        return response.json();
                    })
                    .then(lessons => {
                        displaySchedule(lessons, dateStr);
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        scheduleContainer.innerHTML = `
                            <div class="alert alert-danger">
                                Не удалось загрузить расписание. Попробуйте обновить страницу.
                            </div>
                        `;
                    });
            }

            // Отображение расписания на странице
            function displaySchedule(lessons, dateStr) {
                const formattedDate = formatDate(new Date(dateStr), 'dd.MM.yyyy');
                
                if (!lessons || lessons.length === 0) {
                    scheduleContainer.innerHTML = `
                        <div class="alert alert-info">
                            На ${formattedDate} занятий не найдено.
                        </div>
                    `;
                    return;
                }

                let html = `<h4 class="mb-3">Расписание на ${formattedDate}</h4>`;
                
                lessons.forEach(lesson => {
                    html += `
                        <div class="card schedule-card mb-3">
                            <div class="card-body">
                                <h5 class="card-title">${lesson.subject || 'Без названия'}</h5>
                                <p class="card-text mb-1"><strong>Время:</strong> ${lesson.time || 'Не указано'}</p>
                                <p class="card-text mb-1"><strong>Преподаватель:</strong> ${lesson.teacher || 'Не указан'}</p>
                                <p class="card-text mb-1"><strong>Аудитория:</strong> ${lesson.auditorium || 'Не указана'}</p>
                                <span class="badge bg-secondary">${lesson.type || 'Занятие'}</span>
                            </div>
                        </div>
                    `;
                });

                scheduleContainer.innerHTML = html;
            }

            // Вспомогательные функции для работы с датами
            function formatDate(date, format = 'yyyy-mm-dd') {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');

                if (format === 'dd.MM.yyyy') {
                    return `${day}.${month}.${year}`;
                } else if (format === 'dd.MM') {
                    return `${day}.${month}`;
                }
                return `${year}-${month}-${day}`;
            }

            function isSameDay(date1, date2) {
                return (
                    date1.getFullYear() === date2.getFullYear() &&
                    date1.getMonth() === date2.getMonth() &&
                    date1.getDate() === date2.getDate()
                );
            }

            // Обработчики для кнопок "предыдущая/следующая неделя"
            prevWeekButton.addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderWeekCalendar(currentWeekStart);
            });

            nextWeekButton.addEventListener('click', () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderWeekCalendar(currentWeekStart);
            });

            // Запускаем инициализацию
            initCalendar();
        });
    </script>
</body>
</html>
